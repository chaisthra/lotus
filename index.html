<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Melody of the Lotus Kingdom - A Magical Musical Adventure</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Quicksand:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: linear-gradient(to bottom, #1a1a3e, #2d1b69, #0f0c29);
            --bg-overlay: radial-gradient(ellipse at center, rgba(138, 43, 226, 0.3), rgba(25, 25, 112, 0.6));
            --card-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            --card-border: rgba(255, 182, 193, 0.5);
            --text-primary: white;
            --text-secondary: #f0e6ff;
            --accent-color: #ffb6c1;
            --button-primary: linear-gradient(45deg, #ff6b9d, #c44569);
            --button-secondary: linear-gradient(45deg, #9b59b6, #8e44ad);
            --score-bg: rgba(0, 0, 0, 0.7);
            --petal-slot-border: rgba(255, 182, 193, 0.5);
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(to bottom, #fef7ff, #f3e5ff, #e8d5ff);
            --bg-overlay: radial-gradient(ellipse at center, rgba(138, 43, 226, 0.1), rgba(25, 25, 112, 0.2));
            --card-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            --card-border: rgba(138, 43, 226, 0.4);
            --text-primary: #2d1b69;
            --text-secondary: #4a148c;
            --accent-color: #8e44ad;
            --button-primary: linear-gradient(45deg, #ff6b9d, #c44569);
            --button-secondary: linear-gradient(45deg, #9b59b6, #8e44ad);
            --score-bg: rgba(255, 255, 255, 0.9);
            --petal-slot-border: rgba(138, 43, 226, 0.5);
        }
        
        body {
            margin: 0;
            font-family: 'Quicksand', sans-serif;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.5s ease;
        }
        
        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.3;
        }
        
        #background-music {
            display: none;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        
        #settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 12px;
            font-size: 20px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
        }
        
        #settings-button:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6);
        }
        
        #settings-panel {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-left: 2px solid var(--card-border);
            padding: 80px 20px 20px;
            z-index: 999;
            transition: right 0.3s ease;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
        }
        
        #settings-panel.open {
            right: 0;
        }
        
        .settings-group {
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-family: 'Dancing Script', cursive;
            font-size: 24px;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(255, 182, 193, 0.5);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
        }
        
        .setting-label {
            font-size: 16px;
            color: var(--text-secondary);
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .toggle-switch.active {
            background: var(--accent-color);
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }
        
        #story-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-overlay);
            z-index: 10;
            transition: all 1s ease-out;
        }
        
        .story-card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 30px;
            padding: 20px;
            margin: 20px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(255, 182, 193, 0.3);
            animation: fadeInScale 1s ease-out;
        }
        
        @media (min-width: 768px) {
            .story-card {
                padding: 40px;
            }
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .story-title {
            font-family: 'Dancing Script', cursive;
            font-size: clamp(32px, 8vw, 48px);
            color: var(--accent-color);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 182, 193, 0.8);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255, 182, 193, 0.8); }
            to { text-shadow: 0 0 30px rgba(255, 182, 193, 1), 0 0 40px rgba(255, 182, 193, 0.6); }
        }
        
        .story-text {
            font-size: clamp(16px, 3vw, 18px);
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }
        
        .magic-button {
            background: var(--button-primary);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: clamp(16px, 3vw, 20px);
            font-family: 'Quicksand', sans-serif;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
            position: relative;
            overflow: hidden;
            margin: 5px;
        }
        
        @media (min-width: 768px) {
            .magic-button {
                padding: 15px 40px;
            }
        }
        
        .magic-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
        }
        
        .magic-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .magic-button:hover::before {
            left: 100%;
        }
        
        .story-navigation {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 182, 193, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-dot.active {
            background: var(--accent-color);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.8);
        }
        
        #game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
        }
        
        #game-ui > * {
            pointer-events: auto;
        }
        
        #level-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Dancing Script', cursive;
            font-size: clamp(24px, 5vw, 36px);
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(255, 182, 193, 0.8);
            text-align: center;
            width: 90%;
        }
        
        #score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--score-bg);
            border: 2px solid var(--accent-color);
            border-radius: 20px;
            padding: 10px 20px;
            font-family: 'Dancing Script', cursive;
            font-size: clamp(18px, 4vw, 24px);
            color: var(--accent-color);
            text-shadow: 0 0 10px rgba(255, 182, 193, 0.8);
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        
        @media (min-width: 768px) {
            #score-display {
                font-size: 28px;
                padding: 15px 25px;
            }
        }
        
        #game-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            display: flex;
            gap: 10px;
            pointer-events: auto;
        }
        
        .control-button {
            background: var(--button-secondary);
            border: none;
            color: white;
            padding: 10px 15px;
            font-size: clamp(14px, 3vw, 16px);
            font-family: 'Quicksand', sans-serif;
            font-weight: 600;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
            min-width: 80px;
        }
        
        @media (min-width: 768px) {
            .control-button {
                padding: 12px 20px;
                font-size: 16px;
                min-width: 100px;
            }
        }
        
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.6);
        }
        
        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        #petal-slots {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            pointer-events: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 95%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (min-width: 768px) {
            #petal-slots {
                gap: 15px;
                padding: 20px;
            }
        }
        
        .petal-slot {
            width: 60px;
            height: 60px;
            min-width: 60px;
            border: 3px dashed var(--petal-slot-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .petal-slot {
                width: 80px;
                height: 80px;
                min-width: 80px;
            }
        }
        
        .petal-slot:hover {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .petal-slot.filled {
            background: radial-gradient(circle, rgba(255, 182, 193, 0.3), transparent);
        }
        
        .draggable-petal {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b9d, #dda0dd);
            border-radius: 50% 0;
            cursor: grab;
            position: absolute;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.5);
            touch-action: none;
            z-index: 100;
            pointer-events: auto;
        }
        
        .draggable-petal.dragging {
            cursor: grabbing;
            z-index: 1000;
        }
        
        @media (min-width: 768px) {
            .draggable-petal {
                width: 60px;
                height: 60px;
            }
        }
        
        .draggable-petal:active {
            cursor: grabbing;
            transform: scale(1.2);
        }
        
        #fairy-helper {
            position: absolute;
            top: 160px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #fff9c4, #ffeb3b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            pointer-events: auto;
        }
        
        @media (min-width: 768px) {
            #fairy-helper {
                width: 80px;
                height: 80px;
                font-size: 40px;
                right: 30px;
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        #fairy-message {
            position: absolute;
            top: 160px;
            right: 90px;
            background: rgba(255, 255, 255, 0.95);
            color: #4a148c;
            padding: 12px 16px;
            border-radius: 20px;
            max-width: 200px;
            font-size: 14px;
            display: none;
            animation: fadeInScale 0.5s ease-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        @media (min-width: 768px) {
            #fairy-message {
                right: 130px;
                padding: 15px 20px;
                max-width: 250px;
                font-size: 16px;
            }
        }
        
        #progress-stars {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        @media (min-width: 768px) {
            #progress-stars {
                top: 70px;
                gap: 20px;
            }
        }
        
        .star {
            font-size: 24px;
            color: #666;
            transition: all 0.5s ease;
        }
        
        @media (min-width: 768px) {
            .star {
                font-size: 30px;
            }
        }
        
        .star.earned {
            color: #ffd700;
            animation: starPop 0.5s ease-out;
        }
        
        @keyframes starPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.5); }
            100% { transform: scale(1); }
        }
        
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            animation: sparkleAnim 1s ease-out forwards;
        }
        
        @keyframes sparkleAnim {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        
        #completion-celebration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Dancing Script', cursive;
            font-size: clamp(36px, 8vw, 60px);
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            display: none;
            animation: celebrateAnim 2s ease-out;
            text-align: center;
            width: 90%;
        }
        
        @keyframes celebrateAnim {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(90deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        
        #how-to-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            display: none;
            z-index: 20;
            font-size: 16px;
            line-height: 1.6;
        }
        
        #how-to-play h3 {
            font-family: 'Dancing Script', cursive;
            font-size: 32px;
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
        }
        
        #how-to-play ul {
            list-style: none;
            padding: 0;
        }
        
        #how-to-play li {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }
        
        #how-to-play li:before {
            content: "‚ú®";
            position: absolute;
            left: 0;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 24px;
            cursor: pointer;
        }
        
        .score-popup {
            position: absolute;
            font-family: 'Dancing Script', cursive;
            font-size: 24px;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            pointer-events: none;
            animation: scorePopup 1s ease-out forwards;
            z-index: 1000;
        }
        
        @keyframes scorePopup {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) translateY(-20px);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(-40px);
                opacity: 0;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <video id="video-background" autoplay muted loop>
        <source src="https://ik.imagekit.io/kr7ylbnd3/gemini_pdf_whatsapp/Video_Generation_Confirmation_Link.mp4?updatedAt=1748038294519" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <audio id="background-music" loop>
        <source src="https://ik.imagekit.io/kr7ylbnd3/gemini_pdf_whatsapp/Crown%20of%20Whimsy.mp3?updatedAt=1748038295039" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <button id="settings-button" onclick="toggleSettings()">‚öôÔ∏è</button>
    
    <div id="settings-panel">
        <div class="settings-group">
            <h3 class="settings-title">Audio Settings</h3>
            <div class="setting-item">
                <span class="setting-label">Game Sounds</span>
                <div class="toggle-switch active" onclick="toggleGameSounds()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="setting-item">
                <span class="setting-label">Background Music</span>
                <div class="toggle-switch active" onclick="toggleBackgroundMusic()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-group">
            <h3 class="settings-title">Appearance</h3>
            <div class="setting-item">
                <span class="setting-label">Light Mode</span>
                <div class="toggle-switch" onclick="toggleTheme()">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="how-to-play">
        <button class="close-btn" onclick="hideHowToPlay()">‚úï</button>
        <h3>How to Play üéµ</h3>
        <ul>
            <li><strong>Listen to the Melody:</strong> Each level has a famous tune to recreate</li>
            <li><strong>Drag the Petals:</strong> Click and drag the colorful petals from around the screen</li>
            <li><strong>Drop in Order:</strong> Place them in the slots at the bottom in the correct sequence</li>
            <li><strong>Each Petal = One Note:</strong> Pink petals are lower notes, purple petals are higher</li>
            <li><strong>Get Help:</strong> Click the fairy üßö‚Äç‚ôÄÔ∏è for hints about the melody</li>
            <li><strong>Undo Moves:</strong> Use the Undo button to remove the last placed petal</li>
            <li><strong>Score Points:</strong> Earn points for correct placements and level completions</li>
            <li><strong>Complete 5 Levels:</strong> Start with 3 petals and work up to 16!</li>
            <li><strong>Mobile/Touch:</strong> Tap and drag petals with your finger</li>
        </ul>
        <p style="text-align: center; margin-top: 20px; color: #ffb6c1;">
            <strong>Goal:</strong> Restore the magical chandelier by placing petals in the right order to play beautiful melodies!
        </p>
    </div>
    
    <div id="canvas-container"></div>
    
    <div id="story-overlay">
        <div class="story-card" id="story-card">
            <h1 class="story-title">The Melody of the Lotus Kingdom</h1>
            <p class="story-text" id="story-text">
                In a realm where music flows like rivers and melodies bloom like flowers, the magnificent Lotus Kingdom once thrived in eternal harmony. Every sunrise brought new songs, every sunset a gentle lullaby that tucked the land into peaceful dreams...
            </p>
            <div class="story-navigation">
                <div class="nav-dot active" onclick="showStoryCard(0)"></div>
                <div class="nav-dot" onclick="showStoryCard(1)"></div>
                <div class="nav-dot" onclick="showStoryCard(2)"></div>
                <div class="nav-dot" onclick="showStoryCard(3)"></div>
            </div>
            <div style="margin-top: 20px;">
                <button class="magic-button" onclick="nextStoryCard()" id="next-story-btn">Continue the Tale ‚ú®</button>
                <button class="magic-button" style="background: var(--button-secondary);" onclick="showHowToPlay()">How to Play üìñ</button>
            </div>
        </div>
    </div>
    
    <div id="game-ui">
        <div id="score-display">Score: <span id="score-value">0</span></div>
        <div id="game-controls">
            <button id="undo-button" class="control-button" onclick="undoLastMove()" disabled>Undo ‚Ü∂</button>
        </div>
        <div id="level-indicator">Chapter 1: The First Notes</div>
        <div id="progress-stars">
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
            <span class="star">‚≠ê</span>
        </div>
        <div id="fairy-helper">üßö‚Äç‚ôÄÔ∏è</div>
        <div id="fairy-message">Place the petals in the right order to create the melody!</div>
        <div id="petal-slots"></div>
        <div id="completion-celebration">Magical! ‚ú®</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        let scene, camera, renderer, chandelier;
        let currentLevel = 0;
        let petalGroup, centerMount;
        let draggedPetal = null;
        let placedPetals = [];
        let levelComplete = false;
        let moveHistory = [];
        let score = 0;
        let currentStoryCard = 0;
        
        // Settings
        let gameSoundsEnabled = true;
        let backgroundMusicEnabled = true;
        let isDarkTheme = true;
        
        // Story cards content
        const storyCards = [
            {
                title: "The Melody of the Lotus Kingdom",
                text: "In a realm where music flows like rivers and melodies bloom like flowers, the magnificent Lotus Kingdom once thrived in eternal harmony. Every sunrise brought new songs, every sunset a gentle lullaby that tucked the land into peaceful dreams..."
            },
            {
                title: "The Enchanted Chandelier",
                text: "At the heart of the palace hung a mystical chandelier, its crystal petals holding every beautiful melody ever created. Each petal resonated with pure musical magic, creating symphonies that could heal hearts and bring joy to even the saddest souls..."
            },
            {
                title: "The Dark Sorcerer's Curse",
                text: "But darkness crept into paradise when Malachar, the Shadow Sorcerer, envied the kingdom's musical bliss. In a jealous rage, he shattered the chandelier with a terrible curse, scattering its magical petals across the realm and stealing all music from the land..."
            },
            {
                title: "Princess Aria's Hope",
                text: "Now Princess Aria, the kingdom's most gifted musician, needs a hero with a pure heart and keen ear. Only someone who truly understands the language of melody can restore each petal to its rightful place and bring back the songs of joy. Will you be that hero? ‚ú®"
            }
        ];
        
        // Audio elements for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Sound effect generators
        function playSwooshSound() {
            if (!gameSoundsEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
            
            oscillator.type = 'triangle';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        function playDropSound() {
            if (!gameSoundsEnabled) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);
            
            gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
            
            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }
        
        function playMagicSound() {
            if (!gameSoundsEnabled) return;
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800 + i * 200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1200 + i * 300, audioContext.currentTime + 0.1);
                    
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);
                    
                    oscillator.type = 'square';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }, i * 50);
            }
        }
        
        // Haptic feedback
        function triggerHapticFeedback(pattern = [100]) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }
        
        // Settings functions
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('open');
        }
        
        function toggleGameSounds() {
            gameSoundsEnabled = !gameSoundsEnabled;
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
            
            if (gameSoundsEnabled) {
                playMagicSound();
            }
        }
        
        function toggleBackgroundMusic() {
            backgroundMusicEnabled = !backgroundMusicEnabled;
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
            
            const music = document.getElementById('background-music');
            if (backgroundMusicEnabled) {
                music.play().catch(e => console.log('Music play failed:', e));
            } else {
                music.pause();
            }
        }
        
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const toggle = event.target.closest('.toggle-switch');
            toggle.classList.toggle('active');
            
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            playMagicSound();
        }
        
        // Story navigation functions
        function showStoryCard(index) {
            currentStoryCard = index;
            const card = storyCards[index];
            
            document.getElementById('story-text').textContent = card.text;
            document.querySelector('.story-title').textContent = card.title;
            
            // Update navigation dots
            document.querySelectorAll('.nav-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            // Update button text
            const nextBtn = document.getElementById('next-story-btn');
            if (index === storyCards.length - 1) {
                nextBtn.textContent = 'Begin the Quest ‚ú®';
                nextBtn.onclick = startAdventure;
            } else {
                nextBtn.textContent = 'Continue the Tale ‚ú®';
                nextBtn.onclick = nextStoryCard;
            }
            
            playMagicSound();
        }
        
        function nextStoryCard() {
            if (currentStoryCard < storyCards.length - 1) {
                showStoryCard(currentStoryCard + 1);
            } else {
                startAdventure();
            }
        }
        
        // Level configurations
        const levels = [
            {
                name: "Chapter 1: The First Notes",
                petalCount: 3,
                requiredSequence: ["C4", "E4", "G4"],
                story: "The first three petals hold the simplest melody...",
                melody: "Twinkle Twinkle Little Star (beginning)",
                baseScore: 100
            },
            {
                name: "Chapter 2: The Growing Light",
                petalCount: 5,
                requiredSequence: ["C4", "D4", "E4", "F4", "G4"],
                story: "As the chandelier grows, so does the magic...",
                melody: "Mary Had a Little Lamb",
                baseScore: 200
            },
            {
                name: "Chapter 3: The Dancing Petals",
                petalCount: 8,
                requiredSequence: ["C4", "D4", "E4", "C4", "E4", "C4", "E4", "G4"],
                story: "The petals begin to dance with joy...",
                melody: "Fr√®re Jacques (first part)",
                baseScore: 400
            },
            {
                name: "Chapter 4: The Royal Waltz",
                petalCount: 12,
                requiredSequence: ["G4", "E5", "D5", "C5", "D5", "E5", "G4", "A4", "B4", "C5", "D5", "E5"],
                story: "The palace remembers its grand celebrations...",
                melody: "Beauty and the Beast theme",
                baseScore: 600
            },
            {
                name: "Chapter 5: The Complete Symphony",
                petalCount: 16,
                requiredSequence: ["C4", "E4", "G4", "C5", "E5", "G4", "C5", "E5", "G5", "E5", "C5", "G4", "E4", "C4", "G3", "C4"],
                story: "At last! The complete chandelier shines with all its glory!",
                melody: "A Whole New World (climax)",
                baseScore: 1000
            }
        ];
        
        // Initialize Tone.js
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.2,
                decay: 0.5,
                sustain: 0.6,
                release: 2
            }
        }).toDestination();
        synth.volume.value = -10;
        
        // Add reverb for magical effect
        const reverb = new Tone.Reverb(3).toDestination();
        synth.connect(reverb);

        function init() {
            // Start background music
            const music = document.getElementById('background-music');
            music.volume = 0.3;
            music.play().catch(e => console.log('Music autoplay prevented'));

            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a1a3e, 10, 50);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, -8, 12);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Magical lighting
            const ambientLight = new THREE.AmbientLight(0x404080, 0.5);
            scene.add(ambientLight);

            const moonlight = new THREE.DirectionalLight(0xffffff, 0.5);
            moonlight.position.set(5, 10, 5);
            moonlight.castShadow = true;
            scene.add(moonlight);

            // Add point lights for magical glow
            const magicLight1 = new THREE.PointLight(0xff6b9d, 0.5, 20);
            magicLight1.position.set(-5, 0, 0);
            scene.add(magicLight1);

            const magicLight2 = new THREE.PointLight(0xdda0dd, 0.5, 20);
            magicLight2.position.set(5, 0, 0);
            scene.add(magicLight2);

            createBaseChandelier();
            setupEventListeners();
            animate();
        }

        function createBaseChandelier() {
            chandelier = new THREE.Group();
            
            // Create ornate central mount
            const mountGeometry = new THREE.CylinderGeometry(0.3, 0.5, 0.8, 32);
            const mountMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x4a4a4a,
                emissive: 0x2a2a2a,
                specular: 0x666666,
                shininess: 100
            });
            centerMount = new THREE.Mesh(mountGeometry, mountMaterial);
            centerMount.position.y = 2;
            chandelier.add(centerMount);
            
            // Add decorative crystal
            const crystalGeometry = new THREE.OctahedronGeometry(0.4, 2);
            const crystalMaterial = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                emissive: 0xffb6c1,
                emissiveIntensity: 0.2,
                transparent: true,
                opacity: 0.7,
                specular: 0xffffff,
                shininess: 100
            });
            const crystal = new THREE.Mesh(crystalGeometry, crystalMaterial);
            crystal.position.y = 1.2;
            chandelier.add(crystal);
            
            petalGroup = new THREE.Group();
            chandelier.add(petalGroup);
            
            scene.add(chandelier);
        }

        function setupLevel(levelIndex) {
            currentLevel = levelIndex;
            const level = levels[levelIndex];
            
            // Clear move history for new level
            moveHistory = [];
            updateUndoButton();
            
            // Update UI
            document.getElementById('level-indicator').textContent = level.name;
            showFairyMessage(level.story);
            
            // Clear previous petals
            petalGroup.clear();
            placedPetals = [];
            
            // Create petal slots
            const slotsContainer = document.getElementById('petal-slots');
            slotsContainer.innerHTML = '';
            
            for (let i = 0; i < level.petalCount; i++) {
                const slot = document.createElement('div');
                slot.className = 'petal-slot';
                slot.dataset.index = i;
                slot.addEventListener('drop', handleDrop);
                slot.addEventListener('dragover', handleDragOver);
                slotsContainer.appendChild(slot);
            }
            
            // Create draggable petals (shuffled)
            const shuffledNotes = [...level.requiredSequence].sort(() => Math.random() - 0.5);
            shuffledNotes.forEach((note, i) => {
                createDraggablePetal(note, i);
            });
        }

        function createDraggablePetal(note, index) {
            const petal = document.createElement('div');
            petal.className = 'draggable-petal';
            petal.draggable = true;
            petal.dataset.note = note;
            
            // Calculate position for responsive layout
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            const petalSize = window.innerWidth < 768 ? 50 : 60;
            
            // Distribute petals in a circle around the center
            const angle = (index / levels[currentLevel].petalCount) * Math.PI * 2;
            const radius = Math.min(containerWidth, containerHeight) * 0.3;
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;
            
            petal.style.left = (centerX + Math.cos(angle) * radius - petalSize/2) + 'px';
            petal.style.top = (centerY + Math.sin(angle) * radius - petalSize/2) + 'px';
            
            // Color based on note
            const noteIndex = ["C", "D", "E", "F", "G", "A", "B"].indexOf(note[0]);
            const hue = 0.82 + (noteIndex / 7) * 0.13;
            petal.style.background = `linear-gradient(135deg, 
                hsl(${hue * 360}, 70%, 70%), 
                hsl(${(hue + 0.05) * 360}, 60%, 60%))`;
            
            // Add event listeners for both mouse and touch
            petal.addEventListener('dragstart', handleDragStart);
            petal.addEventListener('dragend', handleDragEnd);
            
            // Touch events for mobile
            petal.addEventListener('touchstart', handleTouchStart, {passive: false});
            petal.addEventListener('touchmove', handleTouchMove, {passive: false});
            petal.addEventListener('touchend', handleTouchEnd, {passive: false});
            
            document.getElementById('game-ui').appendChild(petal);
            
            // Add magical entrance animation
            setTimeout(() => {
                createSparkles(petal.offsetLeft + petalSize/2, petal.offsetTop + petalSize/2);
            }, index * 100);
        }
        
        // Touch event handlers for mobile
        let touchedPetal = null;
        let touchOffset = {x: 0, y: 0};
        
        function handleTouchStart(e) {
            e.preventDefault();
            touchedPetal = e.target;
            const touch = e.touches[0];
            touchOffset.x = touch.clientX - touchedPetal.offsetLeft;
            touchOffset.y = touch.clientY - touchedPetal.offsetTop;
            touchedPetal.style.opacity = '0.5';
            touchedPetal.style.zIndex = '1000';
            touchedPetal.style.transform = 'scale(1.2)';
            
            // Play swoosh sound and haptic feedback
            playSwooshSound();
            triggerHapticFeedback([50]);
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchedPetal) return;
            
            const touch = e.touches[0];
            touchedPetal.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchedPetal.style.top = (touch.clientY - touchOffset.y) + 'px';
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!touchedPetal) return;
            
            touchedPetal.style.opacity = '1';
            touchedPetal.style.transform = 'scale(1)';
            
            // Find element under touch point
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (elementBelow && elementBelow.classList.contains('petal-slot')) {
                // Simulate drop
                draggedPetal = touchedPetal;
                handleDrop({
                    preventDefault: () => {},
                    target: elementBelow,
                    pageX: touch.clientX,
                    pageY: touch.clientY
                });
            }
            
            touchedPetal.style.zIndex = 'auto';
            touchedPetal = null;
        }

        function handleDragStart(e) {
            draggedPetal = e.target;
            e.target.style.opacity = '0.5';
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
            
            // Play swoosh sound and haptic feedback
            playSwooshSound();
            triggerHapticFeedback([50]);
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedPetal) return;
            
            const slot = e.target.classList.contains('petal-slot') ? e.target : e.target.closest('.petal-slot');
            if (!slot || slot.classList.contains('filled')) return;
            
            const slotIndex = parseInt(slot.dataset.index);
            
            // Play drop sound and haptic feedback
            playDropSound();
            triggerHapticFeedback([100, 50, 100]);
            
            // Store move for undo functionality
            const move = {
                petalElement: draggedPetal.cloneNode(true),
                slotIndex: slotIndex,
                note: draggedPetal.dataset.note,
                originalPosition: {
                    left: draggedPetal.style.left,
                    top: draggedPetal.style.top
                }
            };
            moveHistory.push(move);
            updateUndoButton();
            
            // Place petal in slot
            slot.innerHTML = '';
            const petalClone = draggedPetal.cloneNode(true);
            petalClone.style.position = 'relative';
            petalClone.style.left = '0';
            petalClone.style.top = '0';
            petalClone.style.width = window.innerWidth < 768 ? '45px' : '60px';
            petalClone.style.height = window.innerWidth < 768 ? '45px' : '60px';
            petalClone.draggable = false;
            petalClone.style.cursor = 'default';
            slot.appendChild(petalClone);
            slot.classList.add('filled');
            
            // Add petal to 3D chandelier
            add3DPetal(slotIndex, draggedPetal.dataset.note);
            
            // Play note
            playNote(draggedPetal.dataset.note);
            
            // Check if this placement is correct and award points
            const level = levels[currentLevel];
            if (level.requiredSequence[slotIndex] === draggedPetal.dataset.note) {
                const points = 10;
                updateScore(points);
                showScorePopup(e.pageX, e.pageY, `+${points}`);
                playMagicSound();
            }
            
            // Create magical effect
            createSparkles(e.pageX, e.pageY);
            
            // Remove original draggable
            draggedPetal.remove();
            draggedPetal = null;
            
            // Check if level is complete
            checkLevelCompletion();
        }

        function undoLastMove() {
            if (moveHistory.length === 0) return;
            
            const lastMove = moveHistory.pop();
            updateUndoButton();
            
            // Find the slot and remove the petal
            const slot = document.querySelector(`.petal-slot[data-index="${lastMove.slotIndex}"]`);
            if (slot) {
                slot.innerHTML = '';
                slot.classList.remove('filled');
            }
            
            // Remove 3D petal
            if (placedPetals[lastMove.slotIndex]) {
                petalGroup.remove(placedPetals[lastMove.slotIndex].mesh);
                delete placedPetals[lastMove.slotIndex];
            }
            
            // Recreate the draggable petal
            const restoredPetal = lastMove.petalElement.cloneNode(true);
            restoredPetal.style.left = lastMove.originalPosition.left;
            restoredPetal.style.top = lastMove.originalPosition.top;
            restoredPetal.draggable = true;
            
            // Reattach event listeners
            restoredPetal.addEventListener('dragstart', handleDragStart);
            restoredPetal.addEventListener('dragend', handleDragEnd);
            restoredPetal.addEventListener('touchstart', handleTouchStart, {passive: false});
            restoredPetal.addEventListener('touchmove', handleTouchMove, {passive: false});
            restoredPetal.addEventListener('touchend', handleTouchEnd, {passive: false});
            
            document.getElementById('game-ui').appendChild(restoredPetal);
            
            // Subtract points for undo
            updateScore(-5);
            showFairyMessage("Petal returned! Try again! üå∏");
            playSwooshSound();
        }

        function updateUndoButton() {
            const undoButton = document.getElementById('undo-button');
            undoButton.disabled = moveHistory.length === 0;
        }

        function updateScore(points) {
            score += points;
            document.getElementById('score-value').textContent = score;
        }

        function showScorePopup(x, y, text) {
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = text;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 1000);
        }

        function add3DPetal(index, note) {
            const level = levels[currentLevel];
            const angle = (index / level.petalCount) * Math.PI * 2;
            const radius = 2 + currentLevel * 0.5;
            
            // Create 3D petal
            const petalShape = new THREE.Shape();
            petalShape.moveTo(0, 0);
            petalShape.bezierCurveTo(0.2, 0.3, 0.3, 0.8, 0.25, 1.4);
            petalShape.bezierCurveTo(0.2, 1.8, 0.1, 2.0, 0, 2.1);
            petalShape.bezierCurveTo(-0.1, 2.0, -0.2, 1.8, -0.25, 1.4);
            petalShape.bezierCurveTo(-0.3, 0.8, -0.2, 0.3, 0, 0);

            const extrudeSettings = {
                depth: 0.03,
                bevelEnabled: true,
                bevelSegments: 3,
                steps: 2,
                bevelSize: 0.01,
                bevelThickness: 0.01
            };

            const petalGeometry = new THREE.ExtrudeGeometry(petalShape, extrudeSettings);
            
            const noteIndex = ["C", "D", "E", "F", "G", "A", "B"].indexOf(note[0]);
            const hue = 0.82 + (noteIndex / 7) * 0.13;
            
            const petalMaterial = new THREE.MeshPhongMaterial({
                color: new THREE.Color().setHSL(hue, 0.7, 0.6),
                emissive: new THREE.Color().setHSL(hue, 0.7, 0.3),
                emissiveIntensity: 0.3,
                transparent: true,
                opacity: 0.85
            });

            const petal3D = new THREE.Mesh(petalGeometry, petalMaterial);
            petal3D.position.x = Math.cos(angle) * radius;
            petal3D.position.z = Math.sin(angle) * radius;
            petal3D.position.y = 0;
            petal3D.rotation.z = -Math.PI / 4;
            petal3D.rotation.y = angle;
            petal3D.scale.set(0, 0, 0);
            
            // Animate petal appearance
            const targetScale = 1.5 + currentLevel * 0.1;
            animatePetalGrowth(petal3D, targetScale);
            
            petalGroup.add(petal3D);
            placedPetals[index] = { mesh: petal3D, note: note };
        }

        function animatePetalGrowth(petal, targetScale) {
            let scale = 0;
            const animate = () => {
                scale += 0.05;
                if (scale >= targetScale) {
                    scale = targetScale;
                } else {
                    requestAnimationFrame(animate);
                }
                petal.scale.set(scale, scale, scale);
            };
            animate();
        }

        function checkLevelCompletion() {
            const level = levels[currentLevel];
            const filledSlots = document.querySelectorAll('.petal-slot.filled');
            
            if (filledSlots.length === level.petalCount) {
                // Get the sequence of notes placed
                const placedSequence = [];
                filledSlots.forEach(slot => {
                    const petal = slot.querySelector('.draggable-petal');
                    if (petal) {
                        placedSequence.push(petal.dataset.note);
                    }
                });
                
                // Check if sequence is correct
                const isCorrect = placedSequence.every((note, index) => 
                    note === level.requiredSequence[index]
                );
                
                if (isCorrect) {
                    levelComplete = true;
                    celebrateCompletion();
                } else {
                    showFairyMessage("Hmm, that doesn't sound quite right. Let me help you fix that! üéµ");
                    setTimeout(() => resetIncorrectPetals(), 2000);
                }
            }
        }

        function resetIncorrectPetals() {
            const level = levels[currentLevel];
            const filledSlots = document.querySelectorAll('.petal-slot.filled');
            const incorrectPetals = [];
            
            // Identify incorrect petals
            filledSlots.forEach((slot, index) => {
                const petal = slot.querySelector('.draggable-petal');
                if (petal && petal.dataset.note !== level.requiredSequence[index]) {
                    incorrectPetals.push({
                        slot: slot,
                        petal: petal,
                        note: petal.dataset.note,
                        slotIndex: index
                    });
                }
            });
            
            // Remove incorrect petals and recreate them as draggables
            incorrectPetals.forEach((item, removalIndex) => {
                // Remove from slot
                item.slot.innerHTML = '';
                item.slot.classList.remove('filled');
                
                // Remove from 3D chandelier
                if (placedPetals[item.slotIndex]) {
                    petalGroup.remove(placedPetals[item.slotIndex].mesh);
                    delete placedPetals[item.slotIndex];
                }
                
                // Remove from move history entries related to this slot
                moveHistory = moveHistory.filter(move => move.slotIndex !== item.slotIndex);
                updateUndoButton();
                
                // Create new draggable petal
                setTimeout(() => {
                    createDraggablePetal(item.note, removalIndex);
                }, removalIndex * 200); // Stagger the recreation for visual effect
            });
            
            if (incorrectPetals.length > 0) {
                showFairyMessage(`I've returned ${incorrectPetals.length} petal${incorrectPetals.length > 1 ? 's' : ''} for you to try again! üå∏`);
            }
        }

        function celebrateCompletion() {
            const level = levels[currentLevel];
            
            // Award level completion bonus
            const bonusPoints = level.baseScore;
            updateScore(bonusPoints);
            showScorePopup(window.innerWidth / 2, window.innerHeight / 2, `Level Complete! +${bonusPoints}!`);
            
            // Play complete melody
            level.requiredSequence.forEach((note, index) => {
                setTimeout(() => {
                    playNote(note);
                    if (placedPetals[index]) {
                        placedPetals[index].mesh.material.emissiveIntensity = 1;
                        setTimeout(() => {
                            placedPetals[index].mesh.material.emissiveIntensity = 0.3;
                        }, 300);
                    }
                }, index * 300);
            });
            
            // Update stars
            document.querySelectorAll('.star')[currentLevel].classList.add('earned');
            
            // Show celebration
            const celebration = document.getElementById('completion-celebration');
            celebration.style.display = 'block';
            celebration.textContent = level.melody ? `Beautiful! ${level.melody} ‚ú®` : "Magical! ‚ú®";
            
            // Create lots of sparkles
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createSparkles(
                        Math.random() * window.innerWidth,
                        Math.random() * window.innerHeight
                    );
                }, i * 50);
            }
            
            // Haptic celebration
            triggerHapticFeedback([200, 100, 200, 100, 200]);
            
            // Move to next level or end game
            setTimeout(() => {
                celebration.style.display = 'none';
                if (currentLevel < levels.length - 1) {
                    currentLevel++;
                    setupLevel(currentLevel);
                } else {
                    endGame();
                }
            }, 4000);
        }

        function resetLevel() {
            setupLevel(currentLevel);
        }

        function playNote(note) {
            synth.triggerAttackRelease(note, "4n");
        }

        function createSparkles(x, y) {
            for (let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = x + 'px';
                sparkle.style.top = y + 'px';
                sparkle.style.setProperty('--tx', `${(Math.random() - 0.5) * 100}px`);
                sparkle.style.setProperty('--ty', `${(Math.random() - 0.5) * 100}px`);
                document.body.appendChild(sparkle);
                
                setTimeout(() => sparkle.remove(), 1000);
            }
        }

        function showFairyMessage(message) {
            const fairyMessage = document.getElementById('fairy-message');
            fairyMessage.textContent = message;
            fairyMessage.style.display = 'block';
            
            setTimeout(() => {
                fairyMessage.style.display = 'none';
            }, 5000);
        }

        function setupEventListeners() {
            document.getElementById('fairy-helper').addEventListener('click', () => {
                const level = levels[currentLevel];
                showFairyMessage(`Try placing the petals to create: ${level.melody} üéµ`);
                playMagicSound();
            });
            
            window.addEventListener('resize', onWindowResize);
        }

        function startAdventure() {
            document.getElementById('story-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('story-overlay').style.display = 'none';
                document.getElementById('game-ui').style.display = 'block';
                setupLevel(0);
            }, 1000);
        }

        function endGame() {
            const storyOverlay = document.getElementById('story-overlay');
            storyOverlay.style.display = 'flex';
            storyOverlay.style.opacity = '1';
            storyOverlay.innerHTML = `
                <div class="story-card">
                    <h1 class="story-title">The Kingdom Rejoices!</h1>
                    <p class="story-text">
                        You did it! The enchanted chandelier shines brighter than ever before, 
                        filling the Lotus Kingdom with beautiful melodies once again. 
                        Princess Aria and all the kingdom thank you for bringing back their music!
                    </p>
                    <div style="font-size: 32px; margin: 20px 0; color: #ffd700;">
                        Final Score: ${score} ‚ú®
                    </div>
                    <div style="font-size: 60px; margin: 20px 0;">üëëüéµ‚ú®</div>
                    <button class="magic-button" onclick="location.reload()">Play Again ‚ú®</button>
                </div>
            `;
            
            // Final celebration haptic
            triggerHapticFeedback([300, 200, 300, 200, 300]);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Magical floating animation
            if (chandelier) {
                chandelier.rotation.y += 0.003;
                chandelier.position.y = Math.sin(Date.now() * 0.001) * 0.3;
                
                // Make center crystal sparkle
                const crystal = chandelier.children.find(child => 
                    child.geometry && child.geometry.type === 'OctahedronGeometry'
                );
                if (crystal) {
                    crystal.rotation.x += 0.01;
                    crystal.rotation.y += 0.02;
                    crystal.material.emissiveIntensity = 0.2 + Math.sin(Date.now() * 0.003) * 0.1;
                }
                
                // Animate petals gently
                petalGroup.children.forEach((petal, index) => {
                    petal.position.y = Math.sin(Date.now() * 0.001 + index) * 0.1;
                });
            }

            // Add particles effect
            if (Math.random() < 0.02) {
                createBackgroundSparkle();
            }

            renderer.render(scene, camera);
        }

        function createBackgroundSparkle() {
            const geometry = new THREE.SphereGeometry(0.05, 8, 8);
            const material = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            const sparkle = new THREE.Mesh(geometry, material);
            
            sparkle.position.set(
                (Math.random() - 0.5) * 20,
                Math.random() * 10 - 5,
                (Math.random() - 0.5) * 20
            );
            
            scene.add(sparkle);
            
            // Animate and remove
            const animateSparkle = () => {
                sparkle.position.y -= 0.05;
                sparkle.material.opacity -= 0.01;
                
                if (sparkle.material.opacity > 0) {
                    requestAnimationFrame(animateSparkle);
                } else {
                    scene.remove(sparkle);
                }
            };
            animateSparkle();
        }

        function showHowToPlay() {
            document.getElementById('how-to-play').style.display = 'block';
        }
        
        function hideHowToPlay() {
            document.getElementById('how-to-play').style.display = 'none';
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Reposition petals on resize
            const petals = document.querySelectorAll('.draggable-petal');
            petals.forEach((petal, index) => {
                const containerWidth = window.innerWidth;
                const containerHeight = window.innerHeight;
                const petalSize = window.innerWidth < 768 ? 50 : 60;
                const totalPetals = petals.length;
                
                const angle = (index / totalPetals) * Math.PI * 2;
                const radius = Math.min(containerWidth, containerHeight) * 0.3;
                const centerX = containerWidth / 2;
                const centerY = containerHeight / 2;
                
                petal.style.left = (centerX + Math.cos(angle) * radius - petalSize/2) + 'px';
                petal.style.top = (centerY + Math.sin(angle) * radius - petalSize/2) + 'px';
            });
        }

        // Initialize the game
        window.addEventListener('DOMContentLoaded', () => {
            init();
        });
    </script>
</body>
</html>
